<style>
  .example
	{
		background-color: #ddddff;
		margin-left: 60px;
		padding-left: 10px;
		padding-right: 10px;
		display: inline-block;
		line-height: 8px;
	}

	.keyword
	{
		background-color: #dddddd;
		padding: 3px;
	}

	.content_block
	{
		margin: 0 0 8px 30px;
		padding: 6px;
		border: 1px solid rgb(200,200,200);
	}

	.content_block_caption
	{
		font-weight: bold;
		font-size: 20px;
		color: cornflowerblue;
		padding-bottom: 3px;
		border-bottom: 1px dashed black;
	}

	.button_hide
	{
		display: inline-block;
		border-radius: 50%;
		border: 1px solid black;
		margin-right: 15px;
		/*padding: 0 5px 0 5px;*/
		line-height: 15px;
		width: 20px;
		height: 20px;
		text-align: center;
		background-color: lightblue;
		cursor: pointer;

		-webkit-user-select: none;
		-khtml-user-select: none;
		-moz-user-select: none;
		-ms-user-select: none;
		user-select: none;
	}

	.comment
	{
		color: rgb(0,200,0);
	}
</style>

<script>
	function toggleHide(ID)
	{
		var bElem = document.getElementById(ID + "_button");
		var cElem = document.getElementById(ID + "_content");

		if(cElem.style.display == "none")
		{
			cElem.style.display = "";

			bElem.style.fontSize = "";
			bElem.style.lineHeight = "";
			bElem.innerHTML = "-";
		}
		else{
			cElem.style.display = "none";

			bElem.style.fontSize = "18px";
			bElem.style.lineHeight = "18px";
			bElem.innerHTML = "+";
		}
	}
</script>

<p style="font-size: 11px">version from 09.04.2017, written by AgentSmith</p>
<h1 id="ee" style="color: #5e9ca0; text-align: center; transition: transform 4s;" onclick='var a=document.getElementById("ee");if(a.style.transform != ""){a.style.transform=""}else{a.style.transform="rotate(4320deg)"}'><span style="color: #003366;">How to use WSE/LUA</span></h1>

<p>&nbsp;</p>
<p>&nbsp;</p>
<p>WSE/LUA uses a modified version of LuaJIT 2.0.4, which is based on and ABI compatible to Lua 5.1</p>
<p>&nbsp;</p>
<h2><div id="setup_button" class="button_hide" onclick="toggleHide('setup')">-</div><span style="color: #003366;">SETUP</span></h2>
<hr/>
<div id="setup_content">
	<ul>
		<li>Create "warband_dir\Modules\module_name\lua\", module_name should be e.g. Native</li>
		<li>Create main.lua inside it. This file, if it exists, gets loaded and executed by WSE at startup, before any of the module system code.</li>
		<li>Copy header_operations.py to your lua dir. This is so that WSE can translate operation names to opcodes and is neccessary for calling module system operations from lua.</li>
	</ul>
	<h2>&nbsp;</h2>
</div>


<h2><div id="the_game_table_button" class="button_hide" onclick="toggleHide('the_game_table')">-</div><span style="color: #003366;">THE "GAME" TABLE<br /></span></h2>
<hr/>
<div id="the_game_table_content">
	<p><em>The game table is a predefined table that allows you access to the game from lua.</em></p>
	<p style="padding-left: 30px;">&nbsp;</p>

	<div class="content_block">
		<div class="content_block_caption">Operations</div>
		<p>To call operations, use <span class="keyword">game.operation_name(arg1, arg2, ...)</span></p>
		<p style="padding-left: 30px;">Example: <span style="margin-left:0px; line-height: 25px;" class="example">game.display_message("test string")</span></p>
		<p>String and pos arguments are passed to the game via the games registers (overwritting them), starting from reg[128] and counting downwards.</p>
		<p>Notice that the argument type matters. For example, if an operation expects an integer, you cannot pass a string that contains a number.</p>
		<p>Lhs operations ("left hand side", operations that return a value) are written as</p>
		<div class="example">
			<p>intResult = game.lhs_operation(lhs_arg, arg1, arg2, ...)</p>
		</div>
		<p>While most Lhs operations don't require an actual value for lhs_arg (in those cases it's strictly a return variable, for example player_get_gold), some (for example val_add) do, so you have to specify it anyway.</p>
		<p>Real-world lhs_operation example:</p>
		<div class="example">
			<p>local gold = game.player_get_gold(0, playerId)</p>
		</div>
		<p>Return values are:</p>
		<div class="example">
			<div style="display: inline-block; margin-right: 5px;">
				<p>boolDidNotFail, intError</p>
				<p>intResult, intError</p>
				<p>boolDidNotFail, intResult, intError</p>
				<p>intError</p>
			</div>
			<div style="display: inline-block;">
				<p>=&nbsp;&nbsp;game.cf_operation(arg1, arg2, ...) for can_fail operations</p>
				<p>=&nbsp;&nbsp;game.lhs_operation(arg1, arg2, ...) for lhs operations</p>
				<p>=&nbsp;&nbsp;game.cf_lhs_operation(arg1, arg2, ...) for operations which are both can_fail and lhs</p>
				<p>=&nbsp;&nbsp;game.operation(arg1, arg2, ...) for all other operations</p>
			</div>
		</div>
		<p>Note that in Lua, you don't have to assign all return values. For example, if you don't care about the error code, just omit the corresponding lhs var.</p>
		<p>I'm not sure what the error code signalizes, however it should be 0 if there was no error.</p>
	</div>


	<div class="content_block">
		<div class="content_block_caption">Registers</div>
		<p>To access registers, use <span class="keyword">game.reg[n]</span> , <span class="keyword">game.sreg[n]</span> and <span class="keyword">game.preg[n]</span></p>
		<p style="padding-left: 30px;">Example:</p>
		<div class="example">
			<p>game.reg[0] = 123</p>
			<p>local i = game.reg[0]</p>
			<p>game.sreg[0] = "test string"</p>
			<p>local s = game.sreg[0]</p>
			<p>game.preg[0] = game.pos.new()</p>
			<p>local pos = game.preg[0]</p>
		</div>
		<p>As of the current version, registers are copied by value instead of by reference. So doing things like:</p>
		<div class="example">
			<p>game.preg[0]:rotX(30)</p>
		</div>
		<p>Does not change the actual game register. This is likely going to be improved in a future version. What you have to do instead for now is:</p>
		<div class="example">
			<p>local p = game.preg[0]</p>
			<p>p:rotX(30)</p>
			<p>game.preg[0] = p</p>
		</div>
	</div>


	<div class="content_block">
		<div class="content_block_caption">Triggers</div>
		<p>To add triggers, use <span class="keyword">game.addTrigger(strTemplateId, numCheckTime, numDelayTime, numRearmTime, funcConditionsCallback, [funcConsequencesCallback])</span></p>
		<p>These work exactly like module system triggers. Times can be float values or values from header_triggers.py (the numbers, string names are not supported yet), just like you would do it in the MS. The callbacks <strong>must</strong> return a boolean. If conditionsCallback returns false, consequencesCallback will not be executed.</p>
		<p>This function is fairly expensive, as it involves copying the entire array of triggers and then adding the new one.</p>
		<p style="padding-left: 30px;">Example:</p>
		<div class="example">
			<p>function condCB()</p>
			<p>&nbsp; doStuff()</p>
			<p>&nbsp; return true</p>
			<p>end</p>
			<p>game.addTrigger("mst_multiplayer_dm", 1, 0, 0, condCB)</p>
		</div>
		<p>addTrigger returns an integer that is the index of the added trigger.</p>
		<p>You can also remove triggers by using <span class="keyword">game.removeTrigger(strTemplateId, intTriggerIndex)</span>. If intTriggerIndex is negative, the trigger with (numTriggers + intTriggerIndex) gets removed (e.g. to remove the last trigger, use -1).</p>
	</div>


	<div class="content_block">
		<div class="content_block_caption">Iterators</div>
		<p>To use iterators (ty_for_agents, try_for_players, ...), use the provided iterator functions <span class="keyword">game.partiesI, game.agentsI, game.propInstI, game.playersI</span></p>
		<p>These work exactly like module system iterators and take the same arguments.</p>
		<p style="padding-left: 30px;">Example:</p>
		<div class="example">
			<p>for curAgent in game.playersI(true) do <span class="comment">--skip server</span></p>
			<p>&nbsp; foo(curAgent)</p>
			<p>end</p>
		</div>
		<p>There is a limit of 256 iterators that can exist at the same time. This is not an issue when using for-loops, since the iterator gets freed when the loop ends. You should however keep it in mind when initializing the iterators manually (see Other WSE LUA API functions). An iterator gets freed as soon as the call to game.IterNext returns nil.</p>
	</div>

	<div class="content_block">
		<div class="content_block_caption">Positions</div>
		<p>To work with positions, the following "classes" are provided: <span class="keyword">game.rotation, game.pos and vector3</span> (see under miscellaneous)</p>
		<p>Keep in mind that these don't need the fixed point multiplier that the module system requires you to use.</p>
		<p>The MS multiplier is essentially a way of specifying the current unit of length.</p>
		<p style="padding-left: 30px;">MS Example:</p>
		<div class="example">
			<p>set_fixed_point_multiplier(1),</p>
			<p>position_get_x(":x", 0), <span class="comment">#get pos0_x in meters</span></p>
			<p>set_fixed_point_multiplier(100),</p>
			<p>position_get_x(":x", 0), <span class="comment">#get pos0_x in centimeters</span></p>
		</div>
		<p>Consider the lua counterpart to "always have a fixed point multiplier of 1".</p>

		<ul>
			<li>
				<p><span class="keyword">game.rotation</span></p>
				<ul>
					<li>
						<p><span class="keyword">game.rotation.new([obj])</span> - constructor. obj can be used to specify initial values.</p>
					</li>
					<li>
						<p><span class="keyword">game.rotation.prototype</span></p>
						<div class="example">
							<p>s = vector3.new({x = 1}) <span class="comment">--x axis</span></p>
							<p>f = vector3.new({y = 1}) <span class="comment">--forwards/y axis</span></p>
							<p>u = vector3.new({z = 1})  <span class="comment">--up/z axis</span></p>
							<p>function getRot(self) <span class="comment">--returns vector3.new({z = yaw, x = pitch, y = roll})</span></p>
							<p>function rotX(self, angle) <span class="comment">--rotate around x axis, angle in degrees</span></p>
							<p>function rotY(self, angle) <span class="comment">--rotate around y axis, angle in degrees</span></p>
							<p>function rotZ(self, angle) <span class="comment">--rotate around z axis, angle in degrees</span></p>
							<p>function rotate(self, rotVec3) <span class="comment">--rotate around all axis, zxy order, angle in degrees</span></p>
						</div>
					</li>
				</ul>
			</li>
			<li>
				<p><span class="keyword">game.pos</span></p>
				<ul>
					<li>
						<p><span class="keyword">game.pos.new([obj])</span> - constructor. obj can be used to specify initial values.</p>
					</li>
					<li>
						<p><span class="keyword">game.pos.prototype</span></p>
						<div class="example">
							<p>o = vector3.new() <span class="comment">--position</span></p>
							<p>rot = game.rotation.new() <span class="comment">--rotation</span></p>
							
							<p style="padding-left: 90px;">&nbsp;</p>
							<p><span class="comment">--see game.rotation.prototype for these</span></p>
							<p>function getRot(self)</p>
							<p>function rotX(self, angle)</p>
							<p>function rotY(self, angle)</p>
							<p>function rotZ(self, angle)</p>
							<p>function rotate(self, rotVec3)</p>
						</div>
					</li>
				</ul>
			</li>
		</ul>

		<p style="padding-left: 30px;">Example:</p>
		<div class="example">
			<p>local pos0 = game.preg[0]</p>
			<p>local newRot = game.rotation.new(pos0.rot)</p>
			<p>local newPos = game.pos.new({rot = newRot})</p>
			<p>newPos:rotX(45)</p>
			<p>newPos:rotate({x = 90, z = 180})</p>
		</div>

	</div>


	<div class="content_block">
		<div class="content_block_caption">Other functions:</div>
		<ul>
			<li>
				<div>
					<p style="padding-left: 20px;">game.getScriptNo(script_name), use in conjunction with game.call_script(scriptNo, ...)</p>
					<p style="padding-left: 30px;">Example:</p>
					<div class="example">
						<p>local no = game.getScriptNo("game_start")</p>
						<p>game.call_script(no)</p>
					</div>
				</div>
			</li>
			<li>
				<div>
					<p style="padding-left: 20px;">game.getCurTemplateId(), returns the id/name of the current mission template. Note that no template will be loaded at the time main.lua is executed.</p>
				</div>
			</li>
		</ul>
		<p>&nbsp;</p>
		<p style="padding-left: 10px">Other WSE LUA API functions - these could be useful for advanced users, but you should get along fine without ever using them.</p>
		<ul>
			<li style="padding-left: 20px;""><p><span class="keyword">game.execOperation(strOperationName, arg1, arg2, ....)</span> - see operations</p></li>
			<li style="padding-left: 20px;""><span class="keyword">game.getReg(intTypeId, intIndex)</span> typeIds are: 0 = int, 1 = str, 2 = pos</p></li>
			<li style="padding-left: 20px;""><span class="keyword">game.setReg(intTypeId, intIndex, val)</span></p></li>
			<li style="padding-left: 20px;""><span class="keyword">game.partiesIterInit()</span> - returns int iterator ID</p></li>
			<li style="padding-left: 20px;""><span class="keyword">game.agentsIterInit([pos|posRegNo], [intRadius])</span> - returns int iterator ID</p></li>
			<li style="padding-left: 20px;""><span class="keyword">game.propInstIterInit([intScenePropId])</span> - returns int iterator ID</p></li>
			<li style="padding-left: 20px;""><span class="keyword">game.playersIterInit([boolSkipServer])</span> - returns int iterator ID</p></li>
			<li style="padding-left: 20px;""><span class="keyword">game.iterNext(intIteratorID)</span> - returns next int value</p></li>
		</ul>
	</div>
</div>
<p>&nbsp;</p>


<h2><div id="miscellaneous_button" class="button_hide" onclick="toggleHide('miscellaneous')">-</div><span style="color: #003366;">MISCELLANEOUS<br /></span></h2>
<hr />
<div id="miscellaneous_content">
	<div class="content_block">
		<div class="content_block_caption">Globals</div>
		<ul>
			<li style="padding-left: 20px;"><span class="keyword">tableShallowCopy(t, copyMetatable)</span> - returns a copy of table t, however any object items will still reference the same object. If copyMetatable ~= nil, the returned table will have the same metatable as t, as given by getmetatable(t).</li>
			<li style="padding-left: 20px; padding-top: 10px;"><span class="keyword">tableRecursiveCopy(t, copyMetatable)</span> - returns a copy of table t. All table items in t and further down the "tree" will be actual copies by value instead of by reference. If copyMetatable ~= nil, all metatables will be copied (by value), as given by getmetatable(t).</li>
			<li style="padding-left: 20px; padding-top: 10px;">vector3 - class for storing and manipulating 3D vectors
				<ul>
					<li>
						<p style="padding-left: 20px; padding-top: 10px;"><span class="keyword">vector3.prototype</span></p>
						<div class="example">
							<p>x = 0</p>
							<p>y = 0</p>
							<p>z = 0</p>
							<p>function len(self) <span class="comment">--returns the length of the vector</span></p>
						</div>
					</li>
					<li>
						<p style="padding-left: 20px; padding-top: 10px;"><span class="keyword">vector3.new([obj])</span> - constructor. obj; can be used to specify initial values.</p>
					</li>
					<li>
						<p style="padding-left: 20px; padding-top: 10px;"><span class="keyword">vector3 operators</span> + - * ==</p>
					</li>
					<li>
					<p style="padding-left: 20px;">Example:</p>
						<div class="example">
							<p>local vecA = vector3.new({x = 60, y = 30})</p>
							<p>local vecB = vector3.new()</p>
							<p>&nbsp;</p>
							<p>game.display_message(tostring(vecA:len())) <span class="comment">--67.08...</span></p>
							<p>&nbsp;</p>
							<p>if vecA == vecB then</p>
							<p style = "padding-left: 20px;"><span class="comment">--will not happen</span></p>
							<p>end</p>
							<p>&nbsp;</p>
							<p>vecA = vecA * vecB --{60*0, 30*0, 0*0}</p>
							<p>if vecA == vecB then</p>
							<p style = "padding-left: 20px;"><span class="comment">--will happen</span></p>
							<p>end</p>
						</div>
					</li>
				</ul>
			</li>
		</ul>
	</div>

	<div class="content_block">
		<div class="content_block_caption">Sandbox</div>
		<p>Changes include:</p>
		<ul>
			<li>
				<p>Disabled package.loadlib, package.cpath, io.popen. os.execute, os.getenv, os.tmpname, ffi library, loading bytecode (can be exploited)</p>
			</li>
			<li>
				<p>Restrict dofile, loadfile and all IO operations to the lua directory</p>
			</li>
		</ul>
	</div>
</div>